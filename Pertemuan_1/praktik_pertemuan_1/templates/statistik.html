<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Statistik Siswa - Praktik Pertemuan 1</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .navigation {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            text-decoration: none;
            font-weight: bold;
            transition: all 0.3s ease;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .flash-messages {
            margin-bottom: 20px;
        }

        .flash-message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .flash-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .flash-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .flash-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card.purple {
            background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%);
        }

        .stat-card.orange {
            background: linear-gradient(135deg, #fd7e14 0%, #ffc107 100%);
        }

        .stat-card.blue {
            background: linear-gradient(135deg, #007bff 0%, #17a2b8 100%);
        }

        .stat-card.red {
            background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);
        }

        .stat-icon {
            font-size: 3em;
            margin-bottom: 15px;
            display: block;
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .charts-section {
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 1.8em;
            color: #495057;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #e9ecef;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border: 1px solid #e9ecef;
        }

        .chart-title {
            font-size: 1.3em;
            color: #495057;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }

        .chart-canvas {
            max-height: 300px;
        }

        .detailed-stats {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid #e9ecef;
        }

        .stats-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stats-table th {
            background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: bold;
        }

        .stats-table td {
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .stats-table tbody tr:hover {
            background: #f8f9fa;
        }

        .stats-table tbody tr:nth-child(even) {
            background: #f8f9fa;
        }

        .stats-table tbody tr:nth-child(even):hover {
            background: #e9ecef;
        }

        .progress-bar {
            background: #e9ecef;
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
            margin-top: 5px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border-radius: 10px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8em;
            font-weight: bold;
        }

        .insights-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .insights-title {
            color: #856404;
            font-size: 1.5em;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .insight-item {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #ffc107;
        }

        .insight-item h4 {
            color: #856404;
            margin-bottom: 10px;
        }

        .insight-item p {
            color: #6c757d;
            line-height: 1.6;
        }

        .export-section {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
        }

        .export-title {
            color: #1976d2;
            font-size: 1.5em;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .export-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn-export {
            padding: 15px 30px;
            font-size: 1.1em;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .loading .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #6f42c1;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }
            
            .content {
                padding: 20px;
            }
            
            .navigation {
                flex-direction: column;
            }
            
            .btn {
                text-align: center;
                justify-content: center;
            }

            .stats-overview {
                grid-template-columns: 1fr;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .chart-container {
                padding: 20px;
            }

            .export-buttons {
                flex-direction: column;
                align-items: center;
            }

            .btn-export {
                width: 100%;
                max-width: 300px;
            }
        }

        .refresh-info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            color: #0c5460;
        }

        .last-updated {
            font-size: 0.9em;
            color: #6c757d;
            text-align: center;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📊 Statistik Siswa</h1>
            <p>Analisis data dan statistik siswa secara komprehensif</p>
        </div>

        <div class="content">
            <!-- Navigation -->
            <div class="navigation">
                <a href="/" class="btn btn-secondary">
                    ← Kembali ke Daftar Siswa
                </a>
                <a href="/cari" class="btn btn-info">
                    🔍 Cari Siswa
                </a>
                <a href="/tambah" class="btn btn-success">
                    ➕ Tambah Siswa Baru
                </a>
                <a href="/statistik" class="btn btn-primary">
                    🔄 Refresh Data
                </a>
            </div>

            <!-- Flash Messages -->
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    <div class="flash-messages">
                        {% for category, message in messages %}
                            <div class="flash-message flash-{{ category }}">
                                {{ message }}
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
            {% endwith %}

            <!-- Refresh Info -->
            <div class="refresh-info">
                ℹ️ Data statistik diperbarui secara real-time berdasarkan database terkini
            </div>

            <!-- Statistics Overview -->
            <div class="stats-overview">
                <div class="stat-card">
                    <span class="stat-icon">👥</span>
                    <div class="stat-number">{{ total_siswa or 0 }}</div>
                    <div class="stat-label">Total Siswa</div>
                </div>
                <div class="stat-card purple">
                    <span class="stat-icon">🏫</span>
                    <div class="stat-number">{{ total_kelas or 0 }}</div>
                    <div class="stat-label">Jumlah Kelas</div>
                </div>
                <div class="stat-card orange">
                    <span class="stat-icon">📊</span>
                    <div class="stat-number">{{ rata_rata_umur or 0 }}</div>
                    <div class="stat-label">Rata-rata Umur</div>
                </div>
                <div class="stat-card blue">
                    <span class="stat-icon">📈</span>
                    <div class="stat-number">{{ siswa_terbaru or 0 }}</div>
                    <div class="stat-label">Siswa Baru (Bulan Ini)</div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="charts-section">
                <h2 class="section-title">
                    📈 Grafik dan Analisis
                </h2>
                
                <div class="charts-grid">
                    <!-- Class Distribution Chart -->
                    <div class="chart-container">
                        <h3 class="chart-title">Distribusi Siswa per Kelas</h3>
                        <canvas id="classChart" class="chart-canvas"></canvas>
                    </div>

                    <!-- Age Distribution Chart -->
                    <div class="chart-container">
                        <h3 class="chart-title">Distribusi Umur Siswa</h3>
                        <canvas id="ageChart" class="chart-canvas"></canvas>
                    </div>

                    <!-- Monthly Registration Chart -->
                    <div class="chart-container">
                        <h3 class="chart-title">Pendaftaran Siswa per Bulan</h3>
                        <canvas id="monthlyChart" class="chart-canvas"></canvas>
                    </div>

                    <!-- Gender Distribution (if available) -->
                    <div class="chart-container">
                        <h3 class="chart-title">Statistik Tambahan</h3>
                        <canvas id="additionalChart" class="chart-canvas"></canvas>
                    </div>
                </div>
            </div>

            <!-- Detailed Statistics -->
            <div class="detailed-stats">
                <h2 class="section-title">
                    📋 Statistik Detail per Kelas
                </h2>
                
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th>Kelas</th>
                            <th>Jumlah Siswa</th>
                            <th>Persentase</th>
                            <th>Rata-rata Umur</th>
                            <th>Umur Termuda</th>
                            <th>Umur Tertua</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if statistik_kelas %}
                            {% for kelas in statistik_kelas %}
                            <tr>
                                <td><strong>{{ kelas.nama_kelas }}</strong></td>
                                <td>{{ kelas.jumlah_siswa }} siswa</td>
                                <td>
                                    {{ kelas.persentase }}%
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: {{ kelas.persentase }}%">
                                            {{ kelas.persentase }}%
                                        </div>
                                    </div>
                                </td>
                                <td>{{ kelas.rata_rata_umur }} tahun</td>
                                <td>{{ kelas.umur_termuda }} tahun</td>
                                <td>{{ kelas.umur_tertua }} tahun</td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="6" style="text-align: center; color: #6c757d; padding: 40px;">
                                    Belum ada data siswa untuk ditampilkan
                                </td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>

            <!-- Insights Section -->
            <div class="insights-section">
                <h2 class="insights-title">
                    💡 Insight dan Analisis
                </h2>
                
                <div class="insight-item">
                    <h4>📊 Distribusi Kelas</h4>
                    <p>
                        {% if kelas_terbanyak %}
                        Kelas {{ kelas_terbanyak.nama }} memiliki siswa terbanyak dengan {{ kelas_terbanyak.jumlah }} siswa ({{ kelas_terbanyak.persentase }}% dari total).
                        {% else %}
                        Belum ada data distribusi kelas yang tersedia.
                        {% endif %}
                    </p>
                </div>

                <div class="insight-item">
                    <h4>👶 Rentang Usia</h4>
                    <p>
                        {% if rentang_usia %}
                        Siswa termuda berusia {{ rentang_usia.termuda }} tahun dan siswa tertua berusia {{ rentang_usia.tertua }} tahun. 
                        Rentang usia adalah {{ rentang_usia.rentang }} tahun dengan rata-rata {{ rentang_usia.rata_rata }} tahun.
                        {% else %}
                        Belum ada data rentang usia yang tersedia.
                        {% endif %}
                    </p>
                </div>

                <div class="insight-item">
                    <h4>📈 Tren Pendaftaran</h4>
                    <p>
                        {% if tren_pendaftaran %}
                        {{ tren_pendaftaran.deskripsi }}
                        {% else %}
                        Dalam bulan ini terdapat beberapa pendaftaran siswa baru. Sistem akan terus memantau tren pendaftaran untuk analisis yang lebih baik.
                        {% endif %}
                    </p>
                </div>

                <div class="insight-item">
                    <h4>🎯 Rekomendasi</h4>
                    <p>
                        {% if rekomendasi %}
                        {{ rekomendasi }}
                        {% else %}
                        Pertahankan keseimbangan jumlah siswa per kelas untuk pembelajaran yang optimal. 
                        Pertimbangkan untuk membuka kelas baru jika ada kelas yang terlalu penuh (>30 siswa).
                        {% endif %}
                    </p>
                </div>
            </div>

            <!-- Export Section -->
            <div class="export-section">
                <h2 class="export-title">
                    📤 Export Data Statistik
                </h2>
                <p style="margin-bottom: 20px; color: #1976d2;">
                    Unduh laporan statistik dalam berbagai format untuk analisis lebih lanjut
                </p>
                
                <div class="export-buttons">
                    <a href="#" class="btn btn-success btn-export" onclick="exportToPDF()">
                        📄 Export PDF
                    </a>
                    <a href="#" class="btn btn-info btn-export" onclick="exportToExcel()">
                        📊 Export Excel
                    </a>
                    <a href="#" class="btn btn-primary btn-export" onclick="exportToCSV()">
                        📋 Export CSV
                    </a>
                    <a href="#" class="btn btn-secondary btn-export" onclick="printReport()">
                        🖨️ Print Laporan
                    </a>
                </div>
            </div>

            <div class="last-updated">
                📅 Terakhir diperbarui: {{ last_updated or 'Baru saja' }}
            </div>
        </div>
    </div>

    <script>
        // Sample data - in real implementation, this would come from the backend
        const sampleData = {
            classData: {
                labels: ['VII A', 'VII B', 'VIII A', 'VIII B', 'IX A', 'IX B'],
                data: [25, 28, 22, 30, 26, 24]
            },
            ageData: {
                labels: ['12 tahun', '13 tahun', '14 tahun', '15 tahun', '16 tahun'],
                data: [15, 45, 55, 35, 5]
            },
            monthlyData: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun'],
                data: [8, 12, 15, 10, 18, 14]
            }
        };

        // Use backend data if available, otherwise use sample data
        const classData = {{ class_distribution | tojson if class_distribution else 'sampleData.classData' }};
        const ageData = {{ age_distribution | tojson if age_distribution else 'sampleData.ageData' }};
        const monthlyData = {{ monthly_registration | tojson if monthly_registration else 'sampleData.monthlyData' }};

        // Chart configurations
        const chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true
                    }
                }
            }
        };

        // Class Distribution Chart
        const classCtx = document.getElementById('classChart').getContext('2d');
        new Chart(classCtx, {
            type: 'doughnut',
            data: {
                labels: classData.labels,
                datasets: [{
                    data: classData.data,
                    backgroundColor: [
                        '#FF6384',
                        '#36A2EB',
                        '#FFCE56',
                        '#4BC0C0',
                        '#9966FF',
                        '#FF9F40'
                    ],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                ...chartOptions,
                plugins: {
                    ...chartOptions.plugins,
                    title: {
                        display: true,
                        text: 'Distribusi Siswa per Kelas'
                    }
                }
            }
        });

        // Age Distribution Chart
        const ageCtx = document.getElementById('ageChart').getContext('2d');
        new Chart(ageCtx, {
            type: 'bar',
            data: {
                labels: ageData.labels,
                datasets: [{
                    label: 'Jumlah Siswa',
                    data: ageData.data,
                    backgroundColor: 'rgba(54, 162, 235, 0.8)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 2,
                    borderRadius: 5
                }]
            },
            options: {
                ...chartOptions,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 5
                        }
                    }
                }
            }
        });

        // Monthly Registration Chart
        const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
        new Chart(monthlyCtx, {
            type: 'line',
            data: {
                labels: monthlyData.labels,
                datasets: [{
                    label: 'Siswa Baru',
                    data: monthlyData.data,
                    borderColor: 'rgba(75, 192, 192, 1)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: 'rgba(75, 192, 192, 1)',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 6
                }]
            },
            options: {
                ...chartOptions,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 2
                        }
                    }
                }
            }
        });

        // Additional Chart (Sample - can be customized)
        const additionalCtx = document.getElementById('additionalChart').getContext('2d');
        new Chart(additionalCtx, {
            type: 'polarArea',
            data: {
                labels: ['Aktif', 'Cuti', 'Alumni', 'Transfer'],
                datasets: [{
                    data: [85, 5, 8, 2],
                    backgroundColor: [
                        'rgba(40, 167, 69, 0.8)',
                        'rgba(255, 193, 7, 0.8)',
                        'rgba(23, 162, 184, 0.8)',
                        'rgba(220, 53, 69, 0.8)'
                    ],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                ...chartOptions,
                plugins: {
                    ...chartOptions.plugins,
                    title: {
                        display: true,
                        text: 'Status Siswa (%)'
                    }
                }
            }
        });

        // Auto hide flash messages
        setTimeout(function() {
            const flashMessages = document.querySelectorAll('.flash-message');
            flashMessages.forEach(function(message) {
                message.style.transition = 'opacity 0.5s ease';
                message.style.opacity = '0';
                setTimeout(function() {
                    message.remove();
                }, 500);
            });
        }, 5000);

        // Export functions
        function exportToPDF() {
            showLoading();
            // In real implementation, this would call backend API
            setTimeout(() => {
                hideLoading();
                alert('Fitur export PDF akan segera tersedia!');
            }, 2000);
        }

        function exportToExcel() {
            showLoading();
            // In real implementation, this would call backend API
            setTimeout(() => {
                hideLoading();
                alert('Fitur export Excel akan segera tersedia!');
            }, 2000);
        }

        function exportToCSV() {
            // Simple CSV export for statistics table
            const table = document.querySelector('.stats-table');
            const rows = table.querySelectorAll('tr');
            let csv = [];
            
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const cols = row.querySelectorAll('td, th');
                let csvRow = [];
                
                for (let j = 0; j < cols.length; j++) {
                    let cellText = cols[j].textContent.trim();
                    cellText = cellText.replace(/"/g, '""');
                    csvRow.push('"' + cellText + '"');
                }
                
                csv.push(csvRow.join(','));
            }
            
            const csvContent = csv.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', 'statistik_siswa.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        function printReport() {
            window.print();
        }

        function showLoading() {
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'loading';
            loadingDiv.id = 'loadingIndicator';
            loadingDiv.innerHTML = '<div class="spinner"></div><p>Memproses export...</p>';
            document.body.appendChild(loadingDiv);
        }

        function hideLoading() {
            const loadingDiv = document.getElementById('loadingIndicator');
            if (loadingDiv) {
                loadingDiv.remove();
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl+P to print
            if (e.ctrlKey && e.key === 'p') {
                e.preventDefault();
                printReport();
            }
            
            // Ctrl+S to export CSV
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                exportToCSV();
            }
            
            // ESC to go back
            if (e.key === 'Escape') {
                window.location.href = '/';
            }
            
            // F5 to refresh
            if (e.key === 'F5') {
                e.preventDefault();
                window.location.reload();
            }
        });

        // Animate progress bars on load
        document.addEventListener('DOMContentLoaded', function() {
            const progressBars = document.querySelectorAll('.progress-fill');
            progressBars.forEach(bar => {
                const width = bar.style.width;
                bar.style.width = '0%';
                setTimeout(() => {
                    bar.style.width = width;
                }, 500);
            });
        });

        // Auto refresh data every 5 minutes
        setInterval(function() {
            const refreshInfo = document.querySelector('.refresh-info');
            refreshInfo.innerHTML = '🔄 Memperbarui data...';
            
            setTimeout(() => {
                refreshInfo.innerHTML = 'ℹ️ Data statistik diperbarui secara real-time berdasarkan database terkini';
            }, 2000);
        }, 300000); // 5 minutes
    </script>
</body>
</html>